<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Misiva</title>
    <link rel="stylesheet" href="css/main.css" />
  </head>
  <body>
    <header>
      <nav class="container">
        <a href="#home" class="logo" aria-label="Ir a Inicio">Misiva</a>
        <ul class="nav-links">
          <li><a href="#home">Inicio</a></li>
          <li><a href="#process">Proceso</a></li>
          <li><a href="#impact">Impacto</a></li>
          <li><a href="#contact">Contacto</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <section class="hero" id="home">
        <div class="container">
          <h1>Convert√≠ tus residuos en recompensas</h1>
          <p>
            Tra√© tus materiales reciclables y gan√° tokens al instante.
            Intercambi√° tus tokens por valiosas recompensas y ayud√° a construir
            un futuro sostenible.
          </p>

          <div class="exchange-icon">
            <div class="token-animation"></div>
          </div>

          <p class="cta-text">Comenz√° Ahora</p>
          <!--<button class="cta-button">Comienza Ahora</button>-->
        </div>
      </section>

      <section class="process" id="process">
        <div class="container">
          <h2>C√≥mo funciona Misiva</h2>
          <div class="process-grid">
            <div class="process-card">
              <div class="process-icon">
                <img
                  src="img/pastelocation.png"
                  alt="Token Icon"
                  width="75"
                  height="75"
                />
              </div>
              <h3>Visita puntos de canje</h3>
              <p>
                Encontr√° el punto de canje m√°s cercano a tu ubicaci√≥n y tra√© tus
                materiales reciclables a nuestro personal capacitado.
              </p>
            </div>
            <div class="process-card">
              <div class="process-icon">
                <img
                  src="img/verificado.png"
                  alt="Token Icon"
                  width="73"
                  height="73"
                />
              </div>
              <h3>Evaluaci√≥n de Materiales</h3>
              <p>
                El personal evaluar√° que sus materiales reciclables est√©n
                limpios y secos. La entrega de materiales debe ser m√≠nimamente
                de 1kg.
              </p>
            </div>
            <div class="process-card">
              <div class="process-icon">
                <img
                  src="img/ckeck.png"
                  alt="Token Icon"
                  width="70"
                  height="70"
                />
              </div>
              <h3>Ganar Tokens</h3>
              <p>
                Recib√≠ tokens digitales al instante compartiendo tu alias o
                direcci√≥n de billetera electr√≥nica a nuestros operadores de
                Ecopunto.
              </p>
            </div>
            <div class="process-card">
              <div class="process-icon">
                <img
                  src="img/recompensa.png"
                  alt="Token Icon"
                  width="75"
                  height="75"
                />
              </div>
              <h3>Canjea recompensas</h3>
              <p>
                Us√° tus tokens para obtener recompensas, descuentos o incluso
                reembolsos en efectivo de nuestra red de socios.
              </p>
            </div>
          </div>
        </div>
      </section>

      <section class="dashboard" id="impact">
        <div class="container">
          <h2>Panel de impacto comunitario</h2>
          <div class="dashboard-grid">
            <div class="stat-card">
              <h3>20</h3>
              <p>Usuarios Registrados</p>
            </div>
            <div class="stat-card">
              <h3>1.2</h3>
              <p>Toneladas recicladas</p>
            </div>
            <div class="stat-card">
              <h3>Plastico</h3>
              <p>Material mas reciclado</p>
            </div>
            <div class="stat-card">
              <h3>2.4M</h3>
              <p>Tokens distribuidos</p>
            </div>
          </div>

          <div class="leaderboard">
            <h3>üèÜ Top Recicladores del Mes</h3>
            <div class="leader-item">
              <div class="leader-rank">1</div>
              <div class="leader-name">Elon Musk</div>
              <div class="leader-tokens">245 tokens</div>
            </div>
            <div class="leader-item">
              <div class="leader-rank">2</div>
              <div class="leader-name">Mark Zuckerberg</div>
              <div class="leader-tokens">197 tokens</div>
            </div>
            <div class="leader-item">
              <div class="leader-rank">3</div>
              <div class="leader-name">Marco Aurelio</div>
              <div class="leader-tokens">138 tokens</div>
            </div>
            <div class="leader-item">
              <div class="leader-rank">4</div>
              <div class="leader-name">Jhon Doe</div>
              <div class="leader-tokens">110 tokens</div>
            </div>
            <div class="leader-item">
              <div class="leader-rank">5</div>
              <div class="leader-name">Jane Doe</div>
              <div class="leader-tokens">81 tokens</div>
            </div>
          </div>
        </div>
      </section>

      <section class="contact" id="contact">
        <div class="container">
          <h2>Contactanos</h2>
          <div class="contact-grid">
            <div class="contact-info">
              <h3>Informaci√≥n de contacto</h3>
              <p><strong>Email:</strong> hello@misiva.com</p>
              <p><strong>Tel√©fono:</strong> +1 (234) 123-4567</p>
              <p>
                <strong>Direcci√≥n:</strong> 123 Calle Verde, Eco City, EC 12345
              </p>
              <p><strong>Horarios:</strong> Lun-Vie 8AM-6PM, Sab 9AM-4PM</p>

              <h3 style="margin-top: 2rem">Busca los puntos de Ecocanje</h3>
              <p>
                Us√° tu celular para localizar el Ecopunto m√°s cercano a tu √°rea.
              </p>
            </div>

            <div class="contact-form">
              <h3>Mandanos un mensaje</h3>
              <form onsubmit="handleContactForm(event)">
                <div class="form-group">
                  <label for="name">Nombre Completo</label>
                  <input type="text" id="name" name="name" required />
                </div>
                <div class="form-group">
                  <label for="email">Email</label>
                  <input type="email" id="email" name="email" required />
                </div>
                <div class="form-group">
                  <label for="subject">Raz√≥n</label>
                  <input type="text" id="subject" name="subject" required />
                </div>
                <div class="form-group">
                  <label for="message">Mensaje</label>
                  <textarea
                    id="message"
                    name="message"
                    rows="4"
                    required
                  ></textarea>
                </div>
                <button type="submit" class="cta-button">Enviar Mensaje</button>
              </form>
            </div>
          </div>
        </div>
      </section>

      <section class="cta-section" id="join">
        <div class="container">
          <h2>¬øQuer√©s hacer la diferencia?</h2>
          <p>
            Unite a miles de ciudadanos creando un futuro sustentable a trav√©s
            de un sistema de reciclaje basado en token.
          </p>
          <div class="button-group">
            <button class="cta-button">Unite Hoy</button>
            <a href="#process" class="secondary-button">Saber m√°s</a>
          </div>

          <div id="alert-container"></div>
        </div>
      </section>
    </main>

    <footer>
      <div class="container">
        <p>
          &copy; 2025 Misiva. Transformando desechos en recompensas por un
          ma√±ana sustentable.
        </p>
      </div>
    </footer>

    <!-- ========== MODAL DE MINT ========== -->
    <div id="mint-modal">
      <div class="mint-modal-content">
        <h2>Reclamar tu POAP</h2>
        <p>
          Ingres√° tu nombre para recibir tu prueba de participaci√≥n en el
          reciclaje
        </p>
        <!-- ========== SELECTOR DE M√âTODO DE WALLET ========== -->
        <div class="wallet-method-selector">
          <div class="radio-option">
            <input
              type="radio"
              id="wallet-auto"
              name="wallet-method"
              value="auto"
              checked
            />
            <label for="wallet-auto">üíº Wallet Autom√°tica</label>
          </div>
          <div class="radio-option">
            <input
              type="radio"
              id="wallet-metamask"
              name="wallet-method"
              value="metamask"
            />
            <label for="wallet-metamask">ü¶ä MetaMask</label>
          </div>
        </div>
        <!-- ========== SECCI√ìN METAMASK ========== -->
        <div id="metamask-section" style="display: none">
          <button
            type="button"
            id="connect-metamask-btn"
            class="connect-wallet-btn"
          >
            ü¶ä Conectar MetaMask
          </button>
          <div
            id="wallet-connected"
            class="wallet-connected"
            style="display: none"
          >
            <span>‚úÖ Conectado:</span> <span id="connected-address">0x...</span>
          </div>
          <div
            id="metamask-error"
            class="wallet-error"
            style="display: none"
          ></div>
        </div>
        <div class="form-group">
          <label for="user-name-input">Tu nombre</label>
          <input
            type="text"
            id="user-name-input"
            placeholder="Nombre / Apellido"
            maxlength="100"
          />
        </div>
        <div id="mint-error" class="mint-error" style="display: none"></div>
        <div id="mint-loading" class="mint-loading" style="display: none">
          <div class="mint-spinner"></div>
          <p>Minteando tu POAP...</p>
        </div>
        <button id="claim-poap-button" class="claim-button">
          Reclamar POAP
        </button>
      </div>
    </div>
    <!-- ========== POAP CARD ========== -->
    <div id="poap-overlay">
      <div class="poap-card">
        <div class="poap-icon">
          <img src="img/mpoap.svg" alt="POAP Token" width="150" height="150" />
        </div>
        <h3>¬°Felicidades <span id="poap-user-name">Usuario</span>!</h3>
        <p>Recibiste un NFT POAP por tu contribuci√≥n al reciclaje</p>
        <div class="poap-details">
          <p>
            <strong>Wallet:</strong> <span id="poap-wallet-address">0x...</span>
          </p>
          <p><strong>Token ID:</strong> <span id="poap-token-id">#1</span></p>
          <p><strong>Fecha:</strong> <span id="poap-date">21/10/2025</span></p>
        </div>
      </div>
    </div>
    <!-- ========== SCRIPTS ========== -->
    <script type="module">
      // ========== IMPORTS ==========
      import { ethers } from "https://cdn.skypack.dev/ethers@5.7.2";
      import { mintPOAP } from "./js/mint.js";

      // ========== ELEMENTOS DEL DOM ==========
      const mintModal = document.getElementById("mint-modal");
      const poapOverlay = document.getElementById("poap-overlay");
      const userNameInput = document.getElementById("user-name-input");
      const claimButton = document.getElementById("claim-poap-button");
      const loadingDiv = document.getElementById("mint-loading");
      const errorDiv = document.getElementById("mint-error");

      // POAP Card elementos
      const poapUserName = document.getElementById("poap-user-name");
      const poapWalletAddress = document.getElementById("poap-wallet-address");
      const poapTokenId = document.getElementById("poap-token-id");
      const poapDate = document.getElementById("poap-date");

      // ========== VARIABLES METAMASK ==========
      const walletAutoRadio = document.getElementById("wallet-auto");
      const walletMetamaskRadio = document.getElementById("wallet-metamask");
      const metamaskSection = document.getElementById("metamask-section");
      const connectMetamaskBtn = document.getElementById(
        "connect-metamask-btn"
      );
      const walletConnected = document.getElementById("wallet-connected");
      const connectedAddress = document.getElementById("connected-address");
      const metamaskError = document.getElementById("metamask-error");

      let currentMetamaskWallet = null;

      // ========== ABRIR MODAL DE MINT ==========
      function showAuthModal() {
        mintModal.classList.add("active");
        userNameInput.value = "";
        setTimeout(() => userNameInput.focus(), 300);
        hideError();
        // Reset MetaMask state
        walletAutoRadio.checked = true;
        handleWalletMethodChange();
      }

      // ========== CERRAR MODALES ==========
      function closeMintModal() {
        mintModal.classList.remove("active");
      }

      function closePoapCard() {
        poapOverlay.classList.remove("active");
      }

      // ========== MOSTRAR/OCULTAR LOADING ==========
      function showLoading() {
        loadingDiv.style.display = "block";
        claimButton.disabled = true;
        claimButton.textContent = "Minteando...";
      }

      function hideLoading() {
        loadingDiv.style.display = "none";
        claimButton.disabled = false;
        claimButton.textContent = "Reclamar POAP";
      }

      // ========== MOSTRAR/OCULTAR ERROR ==========
      function showError(message) {
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
      }

      function hideError() {
        errorDiv.style.display = "none";
      }

      // ========== FUNCIONES METAMASK ==========
      function showMetamaskError(message) {
        metamaskError.textContent = message;
        metamaskError.style.display = "block";
      }

      function hideMetamaskError() {
        metamaskError.style.display = "none";
      }

      async function connectMetaMask() {
        try {
          // Verificar si MetaMask est√° instalado
          if (!window.ethereum) {
            showMetamaskError(
              "MetaMask no est√° instalado. Por favor inst√°lalo desde metamask.io"
            );
            return;
          }

          hideMetamaskError();
          connectMetamaskBtn.disabled = true;
          connectMetamaskBtn.textContent = "Conectando...";

          // Crear provider con ethers.js
          const provider = new ethers.providers.Web3Provider(window.ethereum);

          // Solicitar conexi√≥n
          await provider.send("eth_requestAccounts", []);

          // Obtener signer y direcci√≥n
          const signer = provider.getSigner();
          const address = await signer.getAddress();

          // Verificar red Hardhat local
          const network = await provider.getNetwork();
          if (network.chainId !== 31337) {
            try {
              await window.ethereum.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: "0x7A69" }], // 31337 en hex
              });
            } catch (switchError) {
              // Si la red no existe, agregarla
              if (switchError.code === 4902) {
                await window.ethereum.request({
                  method: "wallet_addEthereumChain",
                  params: [
                    {
                      chainId: "0x7A69",
                      chainName: "Hardhat Local",
                      nativeCurrency: {
                        name: "ETH",
                        symbol: "ETH",
                        decimals: 18,
                      },
                      rpcUrls: ["http://127.0.0.1:8545"],
                      blockExplorerUrls: null,
                    },
                  ],
                });
              } else {
                throw switchError;
              }
            }
          }

          // Guardar wallet conectada
          currentMetamaskWallet = address;

          // Mostrar wallet conectada
          connectedAddress.textContent = formatMetamaskAddress(
            currentMetamaskWallet
          );
          walletConnected.style.display = "flex";
          connectMetamaskBtn.style.display = "none";

          console.log("ü¶ä MetaMask conectado:", currentMetamaskWallet);
        } catch (error) {
          console.error("Error conectando MetaMask:", error);
          showMetamaskError(error.message || "Error al conectar MetaMask");
        } finally {
          connectMetamaskBtn.disabled = false;
          connectMetamaskBtn.textContent = "ü¶ä Conectar MetaMask";
        }
      }

      function formatMetamaskAddress(address) {
        return `${address.substring(0, 6)}...${address.substring(
          address.length - 4
        )}`;
      }

      function handleWalletMethodChange() {
        if (walletMetamaskRadio.checked) {
          metamaskSection.style.display = "block";
        } else {
          metamaskSection.style.display = "none";
          // Reset MetaMask state
          currentMetamaskWallet = null;
          walletConnected.style.display = "none";
          connectMetamaskBtn.style.display = "block";
          hideMetamaskError();
        }
      }

      // ========== MOSTRAR POAP CARD ==========
      function showPoapCard(data) {
        // Actualizar datos
        poapUserName.textContent = data.userName;
        poapWalletAddress.textContent = data.walletAddressShort;
        poapTokenId.textContent = `#${data.tokenId}`;

        // Formatear fecha
        const date = new Date(data.timestamp);
        poapDate.textContent = date.toLocaleDateString("es-AR");

        // Cerrar modal y mostrar POAP card
        closeMintModal();
        poapOverlay.classList.add("active");
      }

      // ========== HANDLE CLAIM POAP (MODIFICADO) ==========
      async function handleClaimPoap() {
        const userName = userNameInput.value.trim();

        // AGREG√Å ESTO:
        console.log("üîç Debug userName:", userName);
        console.log("üîç userName length:", userName.length);
        console.log("üîç Condici√≥n !userName:", !userName);
        console.log('üîç Condici√≥n userName === "":', userName === "");

        // Validar nombre
        if (!userName) {
          showError("Por favor ingres√° tu nombre");
          return;
        }

        if (userName.length < 2) {
          showError("El nombre debe tener al menos 2 caracteres");
          return;
        }

        if (userName.length > 100) {
          showError("El nombre es demasiado largo (m√°ximo 100 caracteres)");
          return;
        }

        // Verificar m√©todo de wallet seleccionado
        const isMetamaskMethod = walletMetamaskRadio.checked;

        if (isMetamaskMethod && !currentMetamaskWallet) {
          showError("Por favor conect√° tu wallet de MetaMask primero");
          return;
        }

        // Mostrar loading
        showLoading();
        hideError();

        try {
          let result;

          if (isMetamaskMethod) {
            // Usar MetaMask wallet
            console.log("ü¶ä Minteando con MetaMask:", currentMetamaskWallet);
            result = await mintPOAP(userName, currentMetamaskWallet);
          } else {
            // Usar wallet autom√°tica (tu flujo original)
            console.log("üíº Minteando con wallet autom√°tica");
            result = await mintPOAP(userName);
          }

          if (!result.success) {
            throw new Error(result.error);
          }

          // Mostrar POAP card
          showPoapCard(result);
        } catch (error) {
          console.error("Error al reclamar POAP:", error);
          showError(
            error.message || "Error al reclamar POAP. Intent√° de nuevo."
          );
        } finally {
          hideLoading();
        }
      }

      // ========== EVENT LISTENERS ==========

      // Logo clickeable
      const tokenAnimation = document.querySelector(".token-animation");
      tokenAnimation.addEventListener("click", showAuthModal);

      // Bot√≥n "Reclamar POAP"
      claimButton.addEventListener("click", handleClaimPoap);

      // Enter en el input
      userNameInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          handleClaimPoap();
        }
      });

      // Cerrar modal al hacer clic fuera
      mintModal.addEventListener("click", (e) => {
        if (e.target === mintModal) {
          closeMintModal();
        }
      });

      // Cerrar POAP card al hacer clic fuera
      poapOverlay.addEventListener("click", (e) => {
        if (e.target === poapOverlay) {
          closePoapCard();
        }
      });

      // ========== EVENT LISTENERS METAMASK ==========
      walletAutoRadio.addEventListener("change", handleWalletMethodChange);
      walletMetamaskRadio.addEventListener("change", handleWalletMethodChange);
      connectMetamaskBtn.addEventListener("click", connectMetaMask);

      // Formulario de contacto
      window.handleContactForm = function (event) {
        event.preventDefault();
        alert("Formulario enviado! (demo)");
      };

      // Sonido del boton
      const clickSound = document.getElementById("clickSound");

      document
        .querySelector(".token-animation")
        .addEventListener("click", () => {
          clickSound.currentTime = 0;
          clickSound.play().catch((error) => {
            console.log("Error reproduciendo audio:", error);
          });
        });
    </script>
    <audio id="clickSound" preload="auto">
      <source src="sounds/sound.mp3" type="audio/mpeg" />
      <source src="sounds/sound.ogg" type="audio/ogg" />
    </audio>
    <div class="floating-particles" style="top: 15%; left: 10%"></div>
    <div class="floating-particles" style="top: 25%; left: 85%"></div>
    <div class="floating-particles" style="top: 45%; left: 15%"></div>
    <div class="floating-particles" style="top: 65%; left: 90%"></div>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'9965b5b6407b892e',t:'MTc2MTc3Mjc1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>

    <audio id="clickSound" preload="auto">
      <source src="sounds/sound.mp3" type="audio/mpeg" />
      <source src="sounds/sound.ogg" type="audio/ogg" />
    </audio>

    <div class="floating-particles" style="top: 15%; left: 10%"></div>
    <div class="floating-particles" style="top: 25%; left: 85%"></div>
    <div class="floating-particles" style="top: 45%; left: 15%"></div>
    <div class="floating-particles" style="top: 65%; left: 90%"></div>
  </body>
</html>
